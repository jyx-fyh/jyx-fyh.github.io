<!DOCTYPE html><html lang="zh-CN" data-theme="dark"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>cmake学习-从实例入手 | 极简</title><meta name="keywords" content="编译、链接与调试"><meta name="author" content="极简"><meta name="copyright" content="极简"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#0d0d0d"><meta name="referrer" content="no-referrer"><meta name="description" content="概要 本篇笔记从实例出发，逐步分析 cmake 的使用方法。为了更好地拟合真实项目，本实例有如下功能：   添加项目版本号   添加编译选项，可选择使用 myMath 库或第三方 3rdMath 库   使用了静态链接库和动态链接库，既有项目生成的库，也有第三方库   提供了安装功能   能够在 Windows 和 Linux 下成功编译运行  读者可能认为 cmake 本来就是跨平台的，所以支持">
<meta property="og:type" content="article">
<meta property="og:title" content="cmake学习-从实例入手">
<meta property="og:url" content="http://jyxcpp.netlify.app/2023/05/05/cmake%E5%85%A5%E9%97%A8/index.html">
<meta property="og:site_name" content="极简">
<meta property="og:description" content="概要 本篇笔记从实例出发，逐步分析 cmake 的使用方法。为了更好地拟合真实项目，本实例有如下功能：   添加项目版本号   添加编译选项，可选择使用 myMath 库或第三方 3rdMath 库   使用了静态链接库和动态链接库，既有项目生成的库，也有第三方库   提供了安装功能   能够在 Windows 和 Linux 下成功编译运行  读者可能认为 cmake 本来就是跨平台的，所以支持">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://jyxcpp.netlify.app/2022/img/39.jpg">
<meta property="article:published_time" content="2023-05-05T03:36:32.000Z">
<meta property="article:modified_time" content="2023-05-15T02:51:31.916Z">
<meta property="article:author" content="极简">
<meta property="article:tag" content="编译、链接与调试">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://jyxcpp.netlify.app/2022/img/39.jpg"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://jyxcpp.netlify.app/2023/05/05/cmake%E5%85%A5%E9%97%A8/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  noticeOutdate: {"limitDay":300,"position":"top","messagePrev":"本篇文章于","messageNext":"天前发表，某些内容可能已经过时，请注意甄别。"},
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":200},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"limitCount":200,"languages":{"author":"作者: 极简","link":"链接: ","source":"来源: 极简","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: true,
  islazyload: false,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'cmake学习-从实例入手',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2023-05-15 10:51:31'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><!-- 谷歌的html标记--><link rel="alternate" href="/atom.xml" title="极简" type="application/atom+xml">
</head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">加载中...</div></div></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/avatar.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">133</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">20</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">27</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> List</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> Music</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> Movie</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div><div class="menus_item"><a class="site-page" href="/comment/"><i class="fa-fw fa fa-paper-plane"></i><span> Comment</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/2022/img/39.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">极简</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> List</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> Music</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> Movie</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div><div class="menus_item"><a class="site-page" href="/comment/"><i class="fa-fw fa fa-paper-plane"></i><span> Comment</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">cmake学习-从实例入手</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2023-05-05T03:36:32.000Z" title="发表于 2023-05-05 11:36:32">2023-05-05</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2023-05-15T02:51:31.916Z" title="更新于 2023-05-15 10:51:31">2023-05-15</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E7%BC%96%E8%AF%91%E3%80%81%E9%93%BE%E6%8E%A5%E4%B8%8E%E8%B0%83%E8%AF%95/">编译、链接与调试</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">4.7k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>16分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="cmake学习-从实例入手"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h2 id="font-color-red-概要-font"><font color='red'>概要</font></h2>
<p>本篇笔记从实例出发，逐步分析 cmake 的使用方法。为了更好地拟合真实项目，本实例有如下功能：</p>
<ul>
<li>
<p>添加项目版本号</p>
</li>
<li>
<p>添加编译选项，可选择使用 myMath 库或第三方 3rdMath 库</p>
</li>
<li>
<p>使用了静态链接库和动态链接库，既有项目生成的库，也有第三方库</p>
</li>
<li>
<p>提供了安装功能</p>
</li>
<li>
<p>能够在 Windows 和 Linux 下成功编译运行</p>
<blockquote>
<p>读者可能认为 cmake 本来就是跨平台的，所以支持 Windows 和 Linux 应该是理所当然的。实际上，支持跨平台还需要注意一些问题，后文会提到它们。</p>
</blockquote>
</li>
</ul>
<blockquote>
<p>项目地址：<a target="_blank" rel="noopener" href="https://github.com/jyx-fyh/cmakeLearn/tree/master">cmake实例</a></p>
</blockquote>
<p>另外，初学 cmake 的朋友们可以在 Linux 下试试 CLion ，其本身就是用 cmake 管理项目，很容易上手。</p>
<p>分析本项目之前，先来简单了解一下 cmake 。</p>
<h2 id="font-color-red-cmake、nmake、make、makefile-font"><font color='red'>cmake、nmake、make、makefile</font></h2>
<p><img src="/2022/img/v2-497f031761c929e5c036138f938508c6_1440w.webp" alt=""></p>
<p>make 是 Unix/Linux 下的一个构建工具，用于自动化构建和编译过程。它可以读取一个名为 Makefile 的文件，根据其中的指令来编译和链接源代码文件，生成可执行文件或库文件。实际上，make 最后也是调用的 gcc 和 ld 来完成编译和链接任务。Makefile 最早由程序员直接编写，但很快凸显出瓶颈：1）对于大型项目，手写 Makefile 文件相当费时费力；2）Makefile 和 make 都是 Unix/Linux 下管理工程的工具，无法跨平台使用。于是 cmake 应运而生，利用 cmake，<strong>可以根据 CMakelist.txt 在不同的平台下上产生不同的<u><font color='orange'>构建文件</font></u></strong>，<strong>比如 Linux 下产生 Makefile，Windows 下则产生 .sln 解决方案文件和 .vcxproj 项目文件等</strong> 。那么 nmake 呢？在 Linux 下，make 根据 Makefile 来构建项目，而 Windows 下则是 nmake 根据 Makefile 来构建项目。</p>
<h2 id="font-color-red-目录结构-font"><font color='red'>目录结构</font></h2>
<p>为了使后续的讲解更加具体，先给出本项目的目录结构：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">├── <span class="number">3</span>rdParty</span><br><span class="line">│   ├── lib3rdMath</span><br><span class="line">│   │   ├── bin</span><br><span class="line">│   │   │   └── lib3rdMath.a</span><br><span class="line">│   │   └── include</span><br><span class="line">│   │       └── <span class="number">3</span>rdMath.h</span><br><span class="line">│   └── libplay</span><br><span class="line">│       ├── bin</span><br><span class="line">│       │   └── libplay.a</span><br><span class="line">│       └── include</span><br><span class="line">│           └── play.h</span><br><span class="line">├── CMakeLists.txt</span><br><span class="line">├── config.h.in</span><br><span class="line">├── include</span><br><span class="line">│   └── student.h</span><br><span class="line">├── libs</span><br><span class="line">│   ├── CMakeLists.txt</span><br><span class="line">│   ├── myMath</span><br><span class="line">│   │   ├── include</span><br><span class="line">│   │   │   └── myMath.h</span><br><span class="line">│   │   └── src</span><br><span class="line">│   │       └── myMath.c</span><br><span class="line">│   └── work</span><br><span class="line">│       ├── include</span><br><span class="line">│       │   └── work.h</span><br><span class="line">│       └── src</span><br><span class="line">│           └── work.c</span><br><span class="line">├── README.md</span><br><span class="line">└── src</span><br><span class="line">    ├── main.c</span><br><span class="line">    └── student.c</span><br></pre></td></tr></table></figure>
<ul>
<li><code>src</code> 目录用来存放项目的主要逻辑代码，<code>include</code> 则存放对应头文件。</li>
<li><code>lib</code> 目录用来存放项目自己的库的源代码，<strong>myMath是静态库，work是动态库</strong> 。</li>
<li><code>3rdParty</code> 目录存放第三方库文件，包含静态链接库和对应头文件。</li>
<li><code>config.h.in</code> 用来配置项目，后文细说。</li>
<li><code>README</code> 用来简单说明项目的使用方法，必不可少。</li>
<li><code>CMakeLists.txt</code> 当然是用来指挥整个项目的编译啦，注意，文件名严格区分大小写。</li>
</ul>
<h2 id="font-color-red-外部构建-font"><font color='red'>外部构建</font></h2>
<p>通常我们不会在 <strong>根目录（最外层的 CMakeLists.txt 所在的目录）</strong> 中直接编译项目，这样的话生成文件会和源文件会混杂在一起凌乱不堪。常见的做法是在根目录下创建一个 build 目录，然后在 build 中进行编译，这就叫做 <strong>外部构建</strong> ：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mkdir build</span><br><span class="line">cd build</span><br><span class="line">cmake ..</span><br><span class="line">make</span><br></pre></td></tr></table></figure>
<p>这样所有的生成文件都会存放在 build 中，不会影响原来的目录结构。</p>
<p>提到构建目录，就不得不说 cmake 的内置变量 <code>PROJECT_BINARY_DIR</code> 。<strong><code>PROJECT_BINARY_DIR</code> 指向的是我们执行 <code>cmake</code> 命令时所处的目录，对于本项目，就指向 build 目录。<code>PROJECT_SOURCE_DIR</code> 指向的是根目录。</strong> 其他变量见后文。</p>
<h2 id="font-color-red-构建顺序与传播规律-font"><font color='red'>构建顺序与传播规律</font></h2>
<p>cmake 根据 CMakeLists.txt 来生成 Makefile 。<strong>项目的不同目录中可以存在多个 CMakeLists.txt ，它们之间存在一定的联系和依赖关系</strong> 。就本项目而言，内层的 CMakeLists.txt 指导生成 myMath 静态库和 work 动态库，外层的 CMakeList.txt 则需要使用这两个库。<br>
CMakeLists.txt 文件还可以定义一些全局变量或宏，<strong>这些变量或宏可以在不同的CMakeLists.txt文件之间共享和使用</strong> ，以便在整个项目中保持一致性，本项目中外层就向内层传递了 USE_MYMATH 宏，内层判断此宏是否被定义，若定义则会生成 myMath 库，细节后文详述。</p>
<p>内外层的 CMakeLists.txt 是怎么联系起来的呢？很简单，使用 cmake 的内置命令 <code>add_subdirectory</code> 。外层 CMakeLists.txt 中使用此命令来添加内层 CMakeLists.txt 所在的目录，然后 cmake 就会自动搜索该目录下的 CMakeLists.txt 并建立联系。</p>
<p><strong><font color='orange'>绝大多数教程会忽略但又必须提到的一点：cmake 构建项目时采用的是深度优先遍历</font></strong> ，也就是说，扫描 CMakeLists.txt 时只要碰到 <code>add_subdirectory</code> 就会立刻进入内层 CMakeLists.txt 并继续扫描。证明这个结论很简单，利用 cmake 的打印命令 <code>message</code> 即可，如下构建目录：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">dir0</span><br><span class="line">├── CMakeLists.txt</span><br><span class="line">├── dir1</span><br><span class="line">│   ├── CMakeLists.txt</span><br><span class="line">│   └── dir3</span><br><span class="line">│       └── CMakeLists.txt</span><br><span class="line">├── dir2</span><br><span class="line">│   └── CMakeLists.txt</span><br><span class="line">└── main.c</span><br></pre></td></tr></table></figure>
<p>各自目录的 CMakeLists.txt 如下：</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#dir0</span></span><br><span class="line"><span class="keyword">cmake_minimum_required</span>(VERSION <span class="number">3.5</span>)</span><br><span class="line"><span class="keyword">project</span>(untitled C)</span><br><span class="line"><span class="keyword">message</span>(<span class="string">&quot;dir0-before&quot;</span>)</span><br><span class="line"><span class="keyword">add_subdirectory</span>(dir1)</span><br><span class="line"><span class="keyword">add_subdirectory</span>(dir2)</span><br><span class="line"><span class="keyword">message</span>(<span class="string">&quot;dir0-after&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#dir1</span></span><br><span class="line"><span class="keyword">message</span>(<span class="string">&quot;dir1-before&quot;</span>)</span><br><span class="line"><span class="keyword">add_subdirectory</span>(dir3)</span><br><span class="line"><span class="keyword">message</span>(<span class="string">&quot;dir1-after&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#dir2</span></span><br><span class="line"><span class="keyword">message</span>(<span class="string">&quot;dir2&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#dir3</span></span><br><span class="line"><span class="keyword">message</span>(<span class="string">&quot;dir3&quot;</span>)</span><br></pre></td></tr></table></figure>
<p>创建并进入 build 目录，构建项目，提示如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">~/CLionProjects/dir0$ </span><span class="language-bash"><span class="built_in">mkdir</span> build</span></span><br><span class="line"><span class="meta prompt_">~/CLionProjects/dir0$ </span><span class="language-bash"><span class="built_in">cd</span> build/</span></span><br><span class="line"><span class="meta prompt_">~/CLionProjects/dir0/build$ </span><span class="language-bash">cmake ..</span></span><br><span class="line">.....省略......</span><br><span class="line">dir0-before</span><br><span class="line">dir1-before</span><br><span class="line">dir3</span><br><span class="line">dir1-after</span><br><span class="line">dir2</span><br><span class="line">dir0-after</span><br></pre></td></tr></table></figure>
<p>可见，确实是按深度优先顺序来构建的：<br>
<img src="/2022/img/ahshita.png" alt=""></p>
<p>笔者强调这个不起眼的顺序问题是因为它很多时候会影响构建结果，而且错误很难排查。具体而言，<strong><font color='orange'>局部变量（自定义变量）在各层 CMakeLists.txt 中的共享情况就会受构建顺序的影响</font></strong> 。那么，局部变量是如何在各个 CMakeLists.txt 中传递并共享的呢？笔者总结了一个前提条件和两个约束条件：</p>
<p><strong>前提条件：</strong></p>
<ul>
<li>如果想要变量向下层传递，则必须在调用 <code>add_subdirectory</code> 前定义变量。</li>
</ul>
<p><strong>约束条件：</strong></p>
<ul>
<li>作用域：变量只能从外层向内层传递。</li>
<li>继承链：变量只能沿着父（外）子（内）继承链传播，兄弟之间不能共享。</li>
</ul>
<blockquote>
<p><strong><font color='orange'>注意，以上规则只适用于自定义变量，不适用于全局变量，即 cmake 的内置变量。</font></strong></p>
</blockquote>
<p>用下面的图来表示也许更加直观，其中红色箭头代表不能传播，绿色箭头代表可以传播：<br>
<img src="/2022/img/mdfuck.png" alt="dir0定义了A变量,dir1定义了B变量"></p>
<p>另外，<strong><font color='orange'>不仅变量有这样的规则，某些函数也符合此规律</font></strong> ，比如 add_definition，使用此函数定义 C/C++ 宏后，该宏也会按照以上规则传播，同样的还有 option 和 configure_file 函数，下文还会提到这个问题。</p>
<blockquote>
<p><strong><font color='red'>声明：这三个条件是由笔者实践得出，如有错误，敬请指正！</font></strong></p>
</blockquote>
<h2 id="font-color-red-项目分析-font"><font color='red'>项目分析</font></h2>
<p>本项目的目录结构已经在上面给出，下面是内外层的 CMakeLists.txt 和 configure.in.h ：</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#外层CMakeLists.txt</span></span><br><span class="line"><span class="keyword">cmake_minimum_required</span>(VERSION <span class="number">3.5</span>) <span class="comment">#要求cmake最低版本</span></span><br><span class="line"><span class="keyword">project</span>(cmake VERSION <span class="number">3.0</span>) <span class="comment">#指定项目名称和版本</span></span><br><span class="line"><span class="comment"># 是否使用自己的Math库</span></span><br><span class="line"><span class="keyword">option</span> (USE_MYMATH <span class="comment">#添加编译选项,这是变量而不是宏</span></span><br><span class="line">        <span class="string">&quot;Use provided math implementation&quot;</span> <span class="comment">#打印信息</span></span><br><span class="line">        <span class="keyword">ON</span>) <span class="comment">#变量默认值为 ON</span></span><br><span class="line"><span class="keyword">configure_file</span> (<span class="string">&quot;config.h.in&quot;</span> <span class="string">&quot;config.h&quot;</span>) <span class="comment">#添加配置文件,上面的编译选项就记录在配置文件中</span></span><br><span class="line"><span class="keyword">add_subdirectory</span>(libs) <span class="comment">#关联子目录</span></span><br><span class="line"><span class="keyword">aux_source_directory</span>(src/ SRC) <span class="comment">#自动搜索src下的所有文件并赋值给SRC变量</span></span><br><span class="line"><span class="keyword">set</span>(LIB play work) <span class="comment">#将play和work库赋值给LIB变量</span></span><br><span class="line"><span class="comment"># 是否加入 myMath 库</span></span><br><span class="line"><span class="keyword">if</span> (USE_MYMATH)</span><br><span class="line">    <span class="keyword">include_directories</span> (<span class="string">&quot;libs/myMath/include&quot;</span>) <span class="comment">#添加头文件搜索目录</span></span><br><span class="line">    <span class="keyword">set</span> (LIB <span class="variable">$&#123;LIB&#125;</span> myMath) <span class="comment">#向LIB变量中添加myMath</span></span><br><span class="line">    <span class="comment">#推荐使用list(APPEND LIB myMath)代替上行</span></span><br><span class="line"><span class="keyword">else</span> ()</span><br><span class="line">    <span class="keyword">include_directories</span> (<span class="string">&quot;3rdParty/lib3rdMath/include&quot;</span>)</span><br><span class="line">    <span class="keyword">link_directories</span>(<span class="string">&quot;3rdParty/lib3rdMath/bin&quot;</span>) <span class="comment">#添加库文件搜索目录</span></span><br><span class="line">    <span class="keyword">set</span> (LIB <span class="variable">$&#123;LIB&#125;</span> <span class="number">3</span>rdMath)</span><br><span class="line"><span class="keyword">endif</span> (USE_MYMATH)</span><br><span class="line"></span><br><span class="line"><span class="keyword">include_directories</span>(</span><br><span class="line">        <span class="string">&quot;include&quot;</span></span><br><span class="line">        <span class="variable">$&#123;PROJECT_BINARY_DIR&#125;</span> <span class="comment">#config.h</span></span><br><span class="line">        <span class="string">&quot;libs/work/include&quot;</span></span><br><span class="line">        <span class="string">&quot;3rdParty/libplay/include&quot;</span>)</span><br><span class="line"><span class="keyword">link_directories</span>(<span class="string">&quot;3rdParty/libplay/bin&quot;</span>)</span><br><span class="line"><span class="keyword">set</span>(EXECUTABLE_OUTPUT_PATH <span class="variable">$&#123;PROJECT_BINARY_DIR&#125;</span>/bin) <span class="comment">#指定可执行文件的输出目录</span></span><br><span class="line"><span class="keyword">add_executable</span>(ctest <span class="variable">$&#123;SRC&#125;</span>) <span class="comment">#利用SRC变量中的源文件生成可执行文件ctest</span></span><br><span class="line"><span class="keyword">target_link_libraries</span>(ctest <span class="variable">$&#123;LIB&#125;</span>) <span class="comment">#将库文件链接到ctest可执行文件</span></span><br><span class="line"><span class="keyword">install</span> (TARGETS ctest DESTINATION bin) <span class="comment">#安装ctest到目录bin</span></span><br></pre></td></tr></table></figure>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#内层CMakeLists.txt</span></span><br><span class="line"><span class="keyword">aux_source_directory</span>(myMath/src/ myMathSrc)</span><br><span class="line"><span class="keyword">aux_source_directory</span>(work/src workSrc)</span><br><span class="line"><span class="keyword">set</span>(LIBRARY_OUTPUT_PATH <span class="variable">$&#123;PROJECT_BINARY_DIR&#125;</span>/bin) <span class="comment">#设置库文件的输出目录</span></span><br><span class="line"><span class="keyword">if</span> (USE_MYMATH) <span class="comment">#该变量是在上层txt中定义</span></span><br><span class="line">    <span class="keyword">add_library</span>(myMath STATIC <span class="variable">$&#123;myMathSrc&#125;</span>) <span class="comment">#生成myMath静态链接库</span></span><br><span class="line"><span class="keyword">endif</span> (USE_MYMATH)</span><br><span class="line"><span class="keyword">if</span>(WIN32) <span class="comment">#如果是在Windows下构建</span></span><br><span class="line">    <span class="keyword">add_definitions</span>(-D_WIN32_) <span class="comment">#则编译源文件时定义宏_WIN32_</span></span><br><span class="line">    <span class="keyword">set</span>(LIB_POS bin)</span><br><span class="line"><span class="keyword">else</span>()</span><br><span class="line">    <span class="keyword">set</span>(LIB_POS lib)</span><br><span class="line"><span class="keyword">endif</span>()</span><br><span class="line"><span class="keyword">add_library</span>(work SHARED <span class="variable">$&#123;workSrc&#125;</span>) <span class="comment">#生成work共享库</span></span><br><span class="line"><span class="keyword">install</span> (TARGETS work DESTINATION &#123;LIB_POS&#125;) <span class="comment">#将work库安装到&#123;LIB_POS&#125;中</span></span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">//configure.h.in</span><br><span class="line">#cmakedefine USE_MYMATH //如果USE_MYMATH变量为ON,则定义该宏,否则不定义</span><br><span class="line">#define PROJECT_VERSION_MAJOR @PROJECT_VERSION_MAJOR@ //用cmake中的版本变量来定义宏</span><br><span class="line">#define PROJECT_VERSION_MINOR @PROJECT_VERSION_MINOR@ //用cmake中的版本变量来定义宏</span><br><span class="line">#define PROJECT_NAME @PROJECT_NAME@ //用cmake中的名称变量来定义宏</span><br></pre></td></tr></table></figure>
<p>注释较为详细，下面选择性讲解一些需要补充说明的内容。先来分析外层 txt ：</p>
<ul>
<li>
<p><strong>外层 txt 的任务是生成可执行文件并链接库，库的生成则交给内层 txt</strong> 。</p>
</li>
<li>
<p>第 3 行， <code>project</code> 函数指定了项目名称和版本，有什么用呢？首先，指定项目名称后，内置变量 <code>PROJECT_NAME</code> 会被自动赋值为该名称，后续就可以直接使用该变量。<strong><font color='orange'>使用变量的语法为 <code>$&#123;变量名&#125;</code></font></strong> 。其次，指定版本后，内置变量 <code>PROJECT_VERSION_MAJOR</code> （主版本号）和 <code>PROJECT_VERSION_MINOR</code> （副版本号）也会被自动赋值。我们在 <a target="_blank" rel="noopener" href="http://configure.h.in">configure.h.in</a> 中使用了它们，该文件作用见下文。</p>
</li>
<li>
<p>第 5 行，定义了 USE_MYMATH 选项，默认为 ON ，即使用 myMath 库。其实 option 函数完全可以使用 set 函数来替代：</p>
  <figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span>(USE_MYMATH <span class="keyword">ON</span>)</span><br></pre></td></tr></table></figure>
<p>只不过采用 set 则无法被 ccmake 检测为选项。<strong><font color='orange'>ccmake 是 cmake 的扩展，能够在构建时提供简单的可视化界面来配置编译选项</font></strong> ：<br>
<img src="/2022/img/image-20230514102921312.png" alt=""><br>
可见，使用 option 命令则会在 ccmake 中看到 USE_MYMATH 选项。</p>
<blockquote>
<p><strong><font color='orange'>图中的 <code>CMAKE_BUILD_TYPE</code> 也是 cmake 内置的选项，你可以将其定义为 Debug 以开启调试模式（默认是 Release 模式）</font></strong> 。除了这种方式，还可以通过其他cmake变量开启调试：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">//指定CMAKE_CFLAGS参数</span><br><span class="line">cmake -DCMAKE_C_FLAGS=&quot;-g -O0&quot; ..</span><br></pre></td></tr></table></figure>
</blockquote>
</li>
<li>
<p>第 8 行，生成配置文件。<strong><code>configure.h</code> 是 <code>configure.h.in</code> 的输出文件，后者由我们手动编写</strong> 。configure.h 会被输出到构建目录（build）中。<strong><font color='orange'><a target="_blank" rel="noopener" href="http://configure.h.in">configure.h.in</a> 能够使用 CMakeLists.txt 中的变量</font></strong> ，使用方法见上文 <a target="_blank" rel="noopener" href="http://configure.h.in">configure.h.in</a> 。</p>
</li>
<li>
<p><strong><font color='orange'>生成 configure.h 时，需要注意顺序——<a target="_blank" rel="noopener" href="http://configure.h.in">configure.h.in</a> 中使用的变量应该在调用 configure_file 函数前定义</font></strong> 。如果你不信，可以将第 5 行的 option 放到 configure_file 函数之后，编译并运行程序后你会发现奇怪的现象。</p>
<blockquote>
<p>所以为了保险起见，可以总是将 configure_file 放在最后。</p>
</blockquote>
</li>
<li>
<p>第 15 行，<code>set (LIB $&#123;LIB&#125; myMath)</code> 的含义是：如果 LIB 不存在，则为其赋值 myMath；如果存在，则添加值，而不会覆盖原有值。<strong>可以使用可读性更强的 <code>list(APPEND LIB myMath)</code> 来代替</strong> 。</p>
</li>
<li>
<p>第 19 行，添加库文件的搜索目录，这里添加的是第三方库的目录。<strong>注意，对于我们自己生成的库（内层 txt 的第 14 行）则无需手动添加搜索目录，cmake 会自动将库的输出目录（内层第 4 行）添加进去</strong> 。</p>
</li>
<li>
<p><strong>第 32 行，bin 目录是相对路径，其前缀随平台而变化：对于 Linux，前缀为 <code>/usr/local</code> ；对 Windows 而言，前缀为 <code>C:\Program Files (x86)\项目名</code></strong> 。你可以在执行 cmake 时通过 -D 选项来指定安装目录的位置：</p>
  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cmake -DCMAKE_INSTALL_PREFIX=\xxx\yyy</span><br></pre></td></tr></table></figure>
<p><code>CMAKE_INSTALL_PREFIX</code> 是 cmake 内置变量，指定安装目录的前缀。<strong>注意，cmake 的 -D 选项只能定义 CMakeLists.txt 中的变量，不能定义 C/C++ 中的宏</strong> 。</p>
</li>
</ul>
<p>下面来看内层 txt，很简单：</p>
<ul>
<li>
<p>第 8 行，<code>WIN32</code> 也是 cmake 的内置变量，当在 Windows 下构建项目时，该变量就会被定义。</p>
</li>
<li>
<p>第 9 行，<code>add_definition</code> 函数用来添加 C/C++ 的宏定义。</p>
</li>
<li>
<p>第 8~12 行的含义是：如果为 Windows，则将所有库安装到 bin 目录下，即与可执行文件放在一起；如果为 Linux，则将库放在 lib 中，可执行文件放在 bin 中。</p>
<blockquote>
<p>为什么要这样安排呢？因为 Linux 通常将可执行文件放在 usr\bin 下，库文件则放在 usr\lib 中，程序运行时会自动在 usr\lib 中搜寻所需的库文件。而 Windows 的习惯则是将所有库文件（尤其是 dll）和 exe 文件存放在同一个目录，当 exe 运行时，优先从当前目录搜寻库文件，例如 QQ ：<br>
<img src="/2022/img/image-20230514131005841.png" alt="exe与dll一起存放"></p>
</blockquote>
</li>
</ul>
<h2 id="font-color-red-Linux下构建-font"><font color='red'>Linux下构建</font></h2>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">~/cmakeLearn$ </span><span class="language-bash"><span class="built_in">mkdir</span> build</span></span><br><span class="line"><span class="meta prompt_">~/cmakeLearn$ </span><span class="language-bash"><span class="built_in">cd</span> build</span></span><br><span class="line"><span class="meta prompt_">~/cmakeLearn/build$ </span><span class="language-bash">cmake ..</span></span><br><span class="line"><span class="meta prompt_">~/cmakeLearn/build$ </span><span class="language-bash">make</span></span><br></pre></td></tr></table></figure>
<p>默认使用 myMath 库，输出结果如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">~/cmakeLearn/build$ </span><span class="language-bash">./bin/ctest</span> </span><br><span class="line">PROJECT cmake</span><br><span class="line">VERSION 3.0</span><br><span class="line">use myMath.h //myMath库</span><br><span class="line">The older age is 20.</span><br><span class="line">Let&#x27;s sing!  //play库</span><br><span class="line">Let&#x27;s dance! //play库</span><br><span class="line">Let&#x27;s work!  //work库</span><br></pre></td></tr></table></figure>
<p>也可以不使用 myMath 库，方法如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">~/CLionProjects/cmakeLearn/build$ </span><span class="language-bash">cmake -DUSE_MYMATH=OFF ..</span></span><br><span class="line"><span class="meta prompt_">~/CLionProjects/cmakeLearn/build$ </span><span class="language-bash">make</span></span><br></pre></td></tr></table></figure>
<p>输出结果：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">~/cmakeLearn/build$ </span><span class="language-bash">./bin/ctest</span> </span><br><span class="line">PROJECT cmake</span><br><span class="line">VERSION 3.0</span><br><span class="line">use 3rdMath.h</span><br><span class="line">The older age is 20.</span><br><span class="line">Let&#x27;s sing!</span><br><span class="line">Let&#x27;s dance!</span><br><span class="line">Let&#x27;s work!</span><br></pre></td></tr></table></figure>
<p>接着进行安装，输入 <strong><code>sudo make install</code></strong> （一定要 sudo），安装成功：<br>
<img src="/2022/img/image-20230514133434317.png" alt=""></p>
<p><strong><font color='orange'>注意，现在直接在命令行中运行 ctest 可能会提示找不到库文件，这是因为库的默认搜索路径没有包含 /usr/local/lib，所以我们需要将这 lib 目录添加到系统变量</font></strong> ，如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">export LD_LIBRARY_PATH=/usr/local/lib</span><br></pre></td></tr></table></figure>
<blockquote>
<p>这种做法仅临时有效，如果要长期有效，则需要修改 .bashrc 文件。</p>
</blockquote>
<p>然后就可以运行成功啦：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">/$ </span><span class="language-bash">ctest</span></span><br><span class="line">PROJECT cmake</span><br><span class="line">VERSION 3.0</span><br><span class="line">use 3rdMath.h</span><br><span class="line">The older age is 20.</span><br><span class="line">Let&#x27;s sing!</span><br><span class="line">Let&#x27;s dance!</span><br><span class="line">Let&#x27;s work!</span><br></pre></td></tr></table></figure>
<h2 id="font-color-red-Windows下构建-font"><font color='red'>Windows下构建</font></h2>
<p>首先需要安装 cmake，直接去官网下载安装即可。</p>
<p>同样步骤：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt;mkdir build</span><br><span class="line">&gt;<span class="built_in">cd</span> build</span><br><span class="line">&gt;cmake ..</span><br></pre></td></tr></table></figure>
<p><img src="/2022/img/image-20230514135550812.png" alt=""></p>
<blockquote>
<p>目录中的 <code>.sln</code> 、<code>.vcxproj</code> 等文件 VS 的解决方案文件和项目管理文件。不了解 Visual Studio 的工程管理方式的朋友请先移步 <strong><a target="_blank" rel="noopener" href="https://jyx-fyh.github.io/2023/05/02/%E7%BC%96%E8%AF%91%E8%B0%83%E5%BC%8F%E5%A4%A7%E5%9E%8B%E9%A1%B9%E7%9B%AE/">如何使用 VS 编译调试一个大型项目？</a></strong></p>
</blockquote>
<p>打开 cmake.sln 文件：<br>
<img src="/2022/img/image-20230514140109505.png" alt=""></p>
<p>可见，cmake 很智能地将我们的工程分为了 6 个项目，主要是 ctest，myMath 和 work 项目，剩余的 ALL_BUILD、INSTALL、ZERO_CHECK 则是 cmake 自动构建的，作用如下：</p>
<ul>
<li>ALL_BUILD ：相当于 makefile 的默认目标 make all，用于构建整个解决方案，但不包括 INSTALL 。</li>
<li>INSTALL ：执行安装任务，相当于 make install 。</li>
<li>ZERO_CHECK ：检查 CMakeLists.txt 文件是否发生了变化，如果有变化则重新生成构建系统，以确保构建系统始终与 CMakeLists.txt 文件保持同步。通常情况下，不需要手动运行 ZERO_CHECK 项目，因为它会在构建过程中自动运行。</li>
</ul>
<p>编译整个解决方案，然后构建 INSTALL，报错如下：<br>
<img src="/2022/img/image-20230514162003916.png" alt=""></p>
<p>提示权限不够，这是因为 <code>C:\Program Files (x86)</code> 目录需要管理员权限才能进行更改。我们使用管理员权限启动 VS 并打开此 sln，重新编译并 INSTALL，成功：<br>
<img src="/2022/img/image-20230514162319358.png" alt=""></p>
<p>运行 ctest.exe 后只会闪现，你可以在源代码中添加 sleep 函数来仔细看看输出结果。</p>
<hr>
<h2 id="font-color-red-常见变量与函数-font"><font color='red'>常见变量与函数</font></h2>
<table>
<thead>
<tr>
<th style="text-align:left">变量</th>
<th style="text-align:left">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">CMAKE_BINARY_DIR<br />PROJECT_BINARY_DIR</td>
<td style="text-align:left">执行编译时所位于的目录，对于外部构建，则一般为 build 目录。</td>
</tr>
<tr>
<td style="text-align:left">CMAKE_SOURCE_DIR<br />PROJECT_SOURCE_DIR</td>
<td style="text-align:left">工程顶层目录，即最外层 CMakeLists.txt 所在目录。</td>
</tr>
<tr>
<td style="text-align:left">CMAKE_CURRENT_SOURCE_DIR</td>
<td style="text-align:left">当前 CMakeLists.txt 所在的路径。</td>
</tr>
<tr>
<td style="text-align:left">EXECUTABLE_OUTPUT_PATH<br />LIBRARY_OUTPUT_PATH</td>
<td style="text-align:left">最终目标文件存放的路径。</td>
</tr>
<tr>
<td style="text-align:left">PROJECT_NAME</td>
<td style="text-align:left">通过 PROJECT 指令定义的项目名称。</td>
</tr>
<tr>
<td style="text-align:left">CMAKE_INSTALL_PREFIX</td>
<td style="text-align:left">安装目录的前缀</td>
</tr>
<tr>
<td style="text-align:left">CMAKE_BUILD_TYPE</td>
<td style="text-align:left">构建类型，如 Debug 或 Release</td>
</tr>
<tr>
<td style="text-align:left">CMAKE_C_COMPILER</td>
<td style="text-align:left">C 编译器的路径</td>
</tr>
<tr>
<td style="text-align:left">CMAKE_CXX_COMPILER</td>
<td style="text-align:left">C++ 编译器的路径</td>
</tr>
<tr>
<td style="text-align:left">CMAKE_C_FLAGS</td>
<td style="text-align:left">C编译器的编译选项</td>
</tr>
<tr>
<td style="text-align:left">WIN32</td>
<td style="text-align:left">如果是在 Windows 下编译，则会定义该宏。</td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th style="text-align:center">函数</th>
<th style="text-align:center">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">set</td>
<td style="text-align:center">设置变量（覆盖原有值）</td>
</tr>
<tr>
<td style="text-align:center">list</td>
<td style="text-align:center">为变量添加值</td>
</tr>
<tr>
<td style="text-align:center">add_subdirectory</td>
<td style="text-align:center">添加子目录</td>
</tr>
<tr>
<td style="text-align:center">add_definitions</td>
<td style="text-align:center">添加编译器定义</td>
</tr>
<tr>
<td style="text-align:center">configure_file</td>
<td style="text-align:center">用于生成配置文件</td>
</tr>
<tr>
<td style="text-align:center">message</td>
<td style="text-align:center">输出消息到控制台</td>
</tr>
<tr>
<td style="text-align:center">add_executable</td>
<td style="text-align:center">添加可执行文件</td>
</tr>
<tr>
<td style="text-align:center">add_library</td>
<td style="text-align:center">添加库文件</td>
</tr>
<tr>
<td style="text-align:center">aux_source_directory</td>
<td style="text-align:center">自动包含指定目录下的所有文件</td>
</tr>
<tr>
<td style="text-align:center">link_directories</td>
<td style="text-align:center">为整个cmake项目设置库文件搜索目录</td>
</tr>
<tr>
<td style="text-align:center">include_directories</td>
<td style="text-align:center">为整个cmake项目设置头文件搜索目录</td>
</tr>
<tr>
<td style="text-align:center">target_include_directories</td>
<td style="text-align:center">为目标（可执行文件或库）设置头文件搜索路径</td>
</tr>
<tr>
<td style="text-align:center">target_link_directories</td>
<td style="text-align:center">为目标设置库文件搜索路径</td>
</tr>
<tr>
<td style="text-align:center">target_link_libraries</td>
<td style="text-align:center">将指定库链接进目标</td>
</tr>
<tr>
<td style="text-align:center">install</td>
<td style="text-align:center">安装目标文件</td>
</tr>
</tbody>
</table>
<hr>
<h2 id="font-color-red-其他-font"><font color='red'>其他</font></h2>
<ul>
<li>
<p>相比 Linux 下的 ccmake，Windows 下的 cmake 具有更人性化的图形界面，你可以很方便地设置构建目录、安装目录以及编译选项：<br>
<img src="/2022/img/image-20230514170003470.png" alt=""></p>
</li>
<li>
<p>Windows 下执行 cmake 后会生成 sln 文件，此时你可以用 VS 打开该解决方案然后进行编译（正如我们上面所做）；另外，你也可以直接在命令行中编译：</p>
  <figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt;mkdir build</span><br><span class="line">&gt;<span class="built_in">cd</span> build</span><br><span class="line">&gt;cmake  .. </span><br><span class="line">&gt;cmake <span class="literal">--build</span> . <span class="literal">--config</span> Release //以Release模式编译工程</span><br></pre></td></tr></table></figure>
<p><strong><font color='orange'><code>cmake ..</code> 会生成系统默认的构建文件，你能够指定构建文件，可以是 Unix Makefiles、Ninja、Visual Studio 等等</font></strong> ：</p>
  <figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt;cmake <span class="literal">-G</span> <span class="string">&quot;Visual Studio 17&quot;</span> ..</span><br><span class="line">&gt;cmake <span class="literal">--build</span> . <span class="literal">--config</span> Release</span><br></pre></td></tr></table></figure>
<p>这里指定的是 Visual Studio 17 。<strong>执行 <code>cmake --build . --config Release</code> 命令时会使用在 CMake 配置时指定的编译器来构建项目，如果没有指定编译器，则会使用默认的编译器</strong> 。在 Unix/Linux 系统上，通常是 gcc/g++；在 Windows 系统上，通常是 CL.exe 编译器。</p>
</li>
<li>
<p>笔者起初有一个疑惑：我们常说的 Linux 下的编译三部曲：</p>
  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">./configure</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">make</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">make install</span></span><br></pre></td></tr></table></figure>
<p>这个 ./configure 是什么？它和 <code>cmake ..</code> 有什么区别？具体来说，configure 是 Autoconf 的配置文件，Autoconf 通过 configure 文件来生成构建系统，而 cmake 根据 CMakeLists.txt 来生成构建系统。Autoconf 和 cmake 都是跨平台的构建工具，用于自动化配置软件包的编译和安装过程。Autoconf 使用 M4 宏语言和 shell 脚本来编写配置文件，而 CMake 使用自己的 CMake 语言来编写配置文件；M4 宏语言比较复杂，而 CMake 语言简单易懂。选择哪个工具取决于个人的喜好和项目的需求。</p>
</li>
<li>
<p>最后，虽然 cmake 是跨平台构建工具，但如果你想要你的项目能够跨平台运行，首先需要保证你的代码能够兼容多个平台，比如 I/O 复用模块 epoll 只存在于 Linux 下，Windows 对应的为 IOCP，那么你就需要编写不同的代码来适应多个平台。本项目中碰到的跨平台问题是动态链接库的编写，因为 Linux 和 Windows 对动态链接库的处理有所不同，所以也要做一些配置，参见<a href="">静态链接与动态链接</a>。</p>
</li>
</ul>
<p>本文结束。</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="http://jyxcpp.netlify.app">极简</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://jyxcpp.netlify.app/2023/05/05/cmake%E5%85%A5%E9%97%A8/">http://jyxcpp.netlify.app/2023/05/05/cmake%E5%85%A5%E9%97%A8/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://jyxcpp.netlify.app" target="_blank">极简</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E7%BC%96%E8%AF%91%E3%80%81%E9%93%BE%E6%8E%A5%E4%B8%8E%E8%B0%83%E8%AF%95/">编译、链接与调试</a></div><div class="post_share"><div class="social-share" data-image="/2022/img/39.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2023/05/07/%E9%9D%9E%E9%98%BB%E5%A1%9E%E5%A5%97%E6%8E%A5%E5%AD%97%E5%8F%8A%E5%85%B6%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9/"><img class="prev-cover" src="/2022/img/1.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">非阻塞套接字及其注意事项</div></div></a></div><div class="next-post pull-right"><a href="/2023/05/02/%E7%BC%96%E8%AF%91%E8%B0%83%E5%BC%8F%E5%A4%A7%E5%9E%8B%E9%A1%B9%E7%9B%AE/"><img class="next-cover" src="/2022/img/41.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">如何使用VS编译调试一个大型项目?</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2023/05/01/%E7%BB%83%E4%B9%A01-%E7%BC%96%E8%AF%91%E8%B0%83%E8%AF%95teamtalk/" title="练习1-编译调试teamtalk"><img class="cover" src="/2022/img/50.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-05-01</div><div class="title">练习1-编译调试teamtalk</div></div></a></div><div><a href="/2023/05/02/%E7%BC%96%E8%AF%91%E8%B0%83%E5%BC%8F%E5%A4%A7%E5%9E%8B%E9%A1%B9%E7%9B%AE/" title="如何使用VS编译调试一个大型项目?"><img class="cover" src="/2022/img/41.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-05-02</div><div class="title">如何使用VS编译调试一个大型项目?</div></div></a></div><div><a href="/2023/05/16/%E7%BB%83%E4%B9%A02-%E7%BC%96%E8%AF%91%E8%B0%83%E8%AF%95Nginx/" title="练习2-编译调试Nginx"><img class="cover" src="/2022/img/32.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-05-16</div><div class="title">练习2-编译调试Nginx</div></div></a></div><div><a href="/2023/05/20/gdb%E8%B0%83%E8%AF%95-%E5%9F%BA%E7%A1%80/" title="gdb调试-基础"><img class="cover" src="/2022/img/17.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-05-20</div><div class="title">gdb调试-基础</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#font-color-red-%E6%A6%82%E8%A6%81-font"><span class="toc-number">1.</span> <span class="toc-text">概要</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#font-color-red-cmake%E3%80%81nmake%E3%80%81make%E3%80%81makefile-font"><span class="toc-number">2.</span> <span class="toc-text">cmake、nmake、make、makefile</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#font-color-red-%E7%9B%AE%E5%BD%95%E7%BB%93%E6%9E%84-font"><span class="toc-number">3.</span> <span class="toc-text">目录结构</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#font-color-red-%E5%A4%96%E9%83%A8%E6%9E%84%E5%BB%BA-font"><span class="toc-number">4.</span> <span class="toc-text">外部构建</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#font-color-red-%E6%9E%84%E5%BB%BA%E9%A1%BA%E5%BA%8F%E4%B8%8E%E4%BC%A0%E6%92%AD%E8%A7%84%E5%BE%8B-font"><span class="toc-number">5.</span> <span class="toc-text">构建顺序与传播规律</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#font-color-red-%E9%A1%B9%E7%9B%AE%E5%88%86%E6%9E%90-font"><span class="toc-number">6.</span> <span class="toc-text">项目分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#font-color-red-Linux%E4%B8%8B%E6%9E%84%E5%BB%BA-font"><span class="toc-number">7.</span> <span class="toc-text">Linux下构建</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#font-color-red-Windows%E4%B8%8B%E6%9E%84%E5%BB%BA-font"><span class="toc-number">8.</span> <span class="toc-text">Windows下构建</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#font-color-red-%E5%B8%B8%E8%A7%81%E5%8F%98%E9%87%8F%E4%B8%8E%E5%87%BD%E6%95%B0-font"><span class="toc-number">9.</span> <span class="toc-text">常见变量与函数</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#font-color-red-%E5%85%B6%E4%BB%96-font"><span class="toc-number">10.</span> <span class="toc-text">其他</span></a></li></ol></div></div></div></div></main><footer id="footer" style="background: linear-gradient(to right bottom, rgb(0, 255, 240), rgb(92, 159, 247) 40%, rgb(211, 34, 255) 80%);"><div id="footer-wrap"><div class="copyright">&copy;2022 - 2023 By 极简</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text">Hi,welcome to my blog.</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.min.js"></script><script>function panguFn () {
  if (typeof pangu === 'object') pangu.autoSpacingPage()
  else {
    getScript('https://cdn.jsdelivr.net/npm/pangu/dist/browser/pangu.min.js')
      .then(() => {
        pangu.autoSpacingPage()
      })
  }
}

function panguInit () {
  if (false){
    GLOBAL_CONFIG_SITE.isPost && panguFn()
  } else {
    panguFn()
  }
}

document.addEventListener('DOMContentLoaded', panguInit)</script><script src="/js/search/local-search.js"></script><script>var preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded")
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")

  }
}
window.addEventListener('load',preloader.endLoading())</script><div class="js-pjax"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/katex/dist/katex.min.css"><script src="https://cdn.jsdelivr.net/npm/katex/dist/contrib/copy-tex.min.js"></script><script>(() => {
  document.querySelectorAll('#article-container span.katex-display').forEach(item => {
    btf.wrap(item, 'div', { class: 'katex-wrap'})
  })
})()</script><script>(() => {
  const $mermaidWrap = document.querySelectorAll('#article-container .mermaid-wrap')
  if ($mermaidWrap.length) {
    window.runMermaid = () => {
      window.loadMermaid = true
      const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'default'

      Array.from($mermaidWrap).forEach((item, index) => {
        const mermaidSrc = item.firstElementChild
        const mermaidThemeConfig = '%%{init:{ \'theme\':\'' + theme + '\'}}%%\n'
        const mermaidID = 'mermaid-' + index
        const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent
        mermaid.mermaidAPI.render(mermaidID, mermaidDefinition, (svgCode) => {
          mermaidSrc.insertAdjacentHTML('afterend', svgCode)
        })
      })
    }

    const loadMermaid = () => {
      window.loadMermaid ? runMermaid() : getScript('https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js').then(runMermaid)
    }

    window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
  }
})()</script><script>function loadValine () {
  function initValine () {
    const valine = new Valine(Object.assign({
      el: '#vcomment',
      appId: 'ppICFLHVi3M0o7XY5Cntsens-gzGzoHsz',
      appKey: '6qgu3NQ0HfB3CGG9ruP46nAm',
      avatar: 'monsterid',
      serverURLs: '',
      emojiMaps: "",
      path: window.location.pathname,
      visitor: false
    }, null))
  }

  if (typeof Valine === 'function') initValine() 
  else getScript('https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js').then(initValine)
}

if ('Valine' === 'Valine' || !true) {
  if (true) btf.loadComment(document.getElementById('vcomment'),loadValine)
  else setTimeout(loadValine, 0)
} else {
  function loadOtherComment () {
    loadValine()
  }
}</script></div><script defer="defer" id="ribbon" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-ribbon.min.js" size="150" alpha="0.6" zIndex="-1" mobile="false" data-click="false"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>